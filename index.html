<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Shift-Tap</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#12070b">

<style>
:root{
  --bg:#14080b;
  --panel:rgba(255,255,255,.06);
  --line:rgba(255,255,255,.10);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.65);
  --muted2:rgba(255,255,255,.50);

  --green:#32d36e;
  --red:#ff5b5b;
  --blue:#3f79ff;

  --shadow:0 14px 40px rgba(0,0,0,.45);
  --radius:22px;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--text);
  background:linear-gradient(180deg,#2e0a14 0%,#631021 45%,#4a0c1a 70%,#2e0a14 100%);
  overflow-x:hidden;
}

.wrap{max-width:820px;margin:0 auto;padding:18px 16px 28px}

.card{
  border:1px solid var(--line);
  border-radius:var(--radius);
  background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.05));
  box-shadow:var(--shadow);
  padding:16px;
}

.row{display:flex;gap:14px;margin-bottom:14px}
.sp{height:12px}
.hr{height:1px;background:var(--line);margin:14px 0}
.muted{color:var(--muted)}
.muted2{color:var(--muted2)}

.bigTimer{
  text-align:center;
  font-weight:950;
  font-size:clamp(54px,12vw,92px);
  letter-spacing:1px;
}

/* =========================================
   KNOPPEN: basis (voor de 4 home knoppen)
   ========================================= */
.btnHalf{
  flex:1 1 0;
  width:0;                 /* <-- dit forceert exact gelijke breedte */
  min-width:0;

  height:60px;
  border-radius:999px;

  font-weight:900;
  font-size:18px;

  border:0;
  display:flex;
  align-items:center;
  justify-content:center;

  padding:0 26px;
  white-space:nowrap;

  cursor:pointer;
  box-shadow:0 10px 22px rgba(0,0,0,.22);
  transition: transform .12s ease;
}
.btnHalf:hover{ transform: translateY(-2px); }

/* Home kleuren */
.btnStart{background:var(--green);color:#06140d}
.btnPause{background:var(--red);color:#1a0707}
.btnRecup{background:#4b77e6;color:#fff}

/* Home Opslaan = wit */
.btnSave{background:rgba(255,255,255,.92); color:#111}

/* Kleine layout fixes (optioneel) */
.row{ margin-bottom:0; }
.sp{ height:12px; }

/* =========================================
   Cards / entries
   ========================================= */
.grid3{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-top:14px;
}

.miniCard{
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  border-radius:18px;
  padding:14px;
  text-align:center;
  box-shadow:0 10px 22px rgba(0,0,0,.18);
}
.miniCard .k{color:var(--muted);font-weight:900;margin-bottom:6px}
.miniCard .v{font-size:42px;font-weight:950}

.calBadges{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-top:6px;
}
.calBadge{
  font-size:11px;
  font-weight:800;
  padding:4px 8px;
  border-radius:999px;
  background: rgba(0,0,0,.25);
  border: 1px solid rgba(255,255,255,.14);
  opacity:.95;
}

.entry{
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  border-radius:18px;
  padding:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 10px 22px rgba(0,0,0,.18);
}
.entry+.entry{margin-top:10px}

.chip{
  padding:10px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  font-weight:950;
  min-width:72px;
  text-align:center;
}

/* =========================================
   HEADER / ICON BUTTONS
   ========================================= */
.top{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:14px;
  width:100%;
}
.title{min-width:0; width:100%;}
.title h1{margin:0; font-size:34px; line-height:1.05; letter-spacing:.2px}

.sub{ margin-top:6px; font-size:14px; opacity:.75; }

.app-header{
  display:flex;
  flex-direction:column;
  gap:12px;
  width:100%;
}
.app-header-left{
  display:flex;
  gap:14px;
  align-items:flex-start;
  width:100%;
  min-width:0;
}
.app-logo{
  width:52px;
  height:52px;
  object-fit:contain;
  border-radius:12px;
  flex-shrink:0;
  margin-top:4px;
}
.app-title-wrap{ display:flex; flex-direction:column; min-width:0; }
.app-title-wrap h1{
  margin:0;
  font-size:36px;
  line-height:1.05;
  word-break:break-word;
}

.btnIcon{
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color:var(--text);
  cursor:pointer;
  box-shadow: 0 10px 22px rgba(0,0,0,.22);
  transition: transform .08s ease;
}
.btnIcon:active{ transform:scale(0.98); }

.app-header-actions{
  width:100%;
  display:flex;
  gap:12px;
}
.app-header-actions .btnIcon{
  flex:1;
  height:44px;
  border-radius:14px;
  font-size:20px;
  padding:0;
  display:flex;
  align-items:center;
  justify-content:center;
  max-width:none;
}

.btnSmall{
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 12px;
  border-radius:12px;
  font-weight:900;
  box-shadow:0 10px 22px rgba(0,0,0,.18);
}
.btnSmall:active{ transform:scale(0.98); }

.tab{display:block}
.h2Row{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap}
.h2Row h2{margin:0}
.badge{
  padding:10px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  font-weight:950;
}
.badge.ok{outline:2px solid rgba(50,211,110,.35)}
.badge.warn{outline:2px solid rgba(255,91,91,.35)}
.list{margin-top:12px}

.footer{margin-top:16px; text-align:center; color:var(--muted2); font-weight:700}

.btnGhost{
  background: rgba(255,255,255,.06);
  border:1px solid var(--line);
  color:var(--text);
  padding:14px 16px;
  border-radius:16px;
  font-weight:950;
  width:100%;
  box-shadow:0 10px 22px rgba(0,0,0,.18);
}
.btnDanger{
  background:var(--red);
  color:#1a0707;
  border:1px solid rgba(0,0,0,.1);
}

/* Status */
.status{
  display:flex; gap:10px; align-items:center; justify-content:center;
  margin-top:10px; margin-bottom:12px;
  color:var(--muted);
  font-weight:900;
}
.iconBox{
  width:14px; height:14px; border-radius:4px; display:inline-block;
  box-shadow:0 8px 18px rgba(0,0,0,.22);
}
.iconBox.play{background:var(--green)}
.iconBox.pause{background:var(--red)}
.iconBox.stop{background:rgba(255,255,255,.25)}

.timerTopLine{display:flex; justify-content:center; margin-bottom:10px}
.timerDateValue{
  padding:10px 14px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  font-weight:950;
}

.saldoMain{font-size:28px; font-weight:950}
.saldoSub{margin-top:8px; font-size:14px; color:var(--muted)}
.unit{font-size:14px; font-weight:900; color:var(--muted)}

.salpos{outline:2px solid rgba(50,211,110,.35)}
.salneg{outline:2px solid rgba(255,91,91,.35)}
.salzero{outline:2px solid rgba(255,255,255,.14)}

.noteLine{color:var(--muted2); font-weight:800}

/* Toast */
.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%) translateY(20px);
  opacity:0;
  pointer-events:none;
  transition:all .18s ease;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--line);
  background:#111;
  color:#fff;
  font-weight:950;
  z-index:120;
  box-shadow:0 14px 40px rgba(0,0,0,.45);
}
.toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
.toast.ok{background:rgba(50,211,110,.20)}
.toast.warn{background:rgba(255,155,0,.18)}
.toast.err{background:rgba(255,91,91,.18)}

/* =========================================
   MODALS
   ========================================= */
.modalBack{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:99;
}
.modal{
  position:relative;
  width:100%;
  max-width:680px;
  border-radius:22px;
  border:1px solid var(--line);
  background:#1a0a10;
  box-shadow:0 20px 70px rgba(0,0,0,.6);
  padding:16px;
}
.modalActions{
  display:flex;
  gap:12px;
  justify-content:flex-end;
  margin-top:14px;
}

/* Modal close X */
.modalCloseBtn{
  position:absolute;
  top:14px;
  right:18px;
  background:transparent;
  border:none;
  font-size:34px;
  font-weight:900;
  color: rgba(255,255,255,0.7);
  cursor:pointer;
  padding:0;
  line-height:1;
  transition:0.2s ease;
}
.modalCloseBtn:hover{ color:#ff5b5b; transform:scale(1.15); }

/* Modal alignment clean */
#modalBack .row2,
#modalBack .row3{ display:block !important; }

#modalBack .row2 > div,
#modalBack .row3 > div{
  width:min(92vw,420px);
  margin:0 auto 10px auto;
  display:grid;
  grid-template-columns:140px 1fr;
  gap:12px;
  align-items:center;
}
/* FIX overflow rechts in modal grid */
#modalBack .row2 > div,
#modalBack .row3 > div{
  width:100% !important;        /* ipv min(92vw,420px) */
  max-width:420px !important;
}

#modalBack .row2 > div > *,
#modalBack .row3 > div > *{
  min-width:0 !important;       /* laat grid items krimpen */
}

#modalBack select,
#modalBack input,
#modalBack textarea{
  width:100% !important;
  max-width:100% !important;
}
#modalBack .row2 label,
#modalBack .row3 label{
  margin:0;
  text-align:left;
  white-space:nowrap;
}
#modalBack .row2 input,
#modalBack .row2 select,
#modalBack .row3 input,
#modalBack .row3 select{
  width:100%;
}
#modalBack #mNote{ width:100%; box-sizing:border-box; }

@media(max-width:420px){
  #modalBack .row2 > div,
  #modalBack .row3 > div{
    grid-template-columns:120px 1fr;
  }
}

/* Dark inputs ‚Äì overal */
input, select, textarea{
  background: rgba(255,255,255,0.10);
  color: rgba(255,255,255,0.92);
  border: 1px solid rgba(255,255,255,0.20);
  border-radius: 10px;
  padding: 8px 10px;
  outline: none;
}
input::placeholder, textarea::placeholder{ color: rgba(255,255,255,0.55); }

/* Dropdown lijst zelf ook donkerder */
select option{ background:#1b0b10; color:#fff; }

/* Android date/time dark */
input[type="date"], input[type="time"], select{ color-scheme: dark; }
input::-webkit-calendar-picker-indicator{ filter: invert(1); }


/* Modal save knop (groen pill, rechts) */
#btnSaveModal,
#btnSaveVerreken,
#btnSaveVerrekening{
  background: linear-gradient(180deg, rgba(50,211,110,.95), rgba(25,170,85,.95));
  color:#fff;
  border:0;
  border-radius:999px;
  height:56px;
  padding:0 26px;
  font-weight:900;
  font-size:18px;
  cursor:pointer;
  transition:0.2s ease;

  display:inline-flex;
  align-items:center;
  justify-content:center;

  margin-left:auto;
  box-shadow: 0 6px 18px rgba(0,255,120,.20);
}

#btnSaveModal:hover,
#btnSaveVerreken:hover,
#btnSaveVerrekening:hover{
  transform: translateY(-2px);
  box-shadow: 0 10px 24px rgba(0,255,120,.22);
}
/* Confirm modal (als je die gebruikt) */
.appModalOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:200;
}
.appModalOverlay.show{display:flex}
.appModal{
  width:100%;
  max-width:520px;
  border-radius:22px;
  border:1px solid var(--line);
  background:#1a0a10;
  box-shadow:0 20px 70px rgba(0,0,0,.6);
  padding:16px;
}
.appModalHeader{font-weight:950; font-size:18px; margin-bottom:10px}
.appModalBody{color:var(--text); opacity:.9; font-weight:800}
.appModalActions{display:flex; gap:12px; justify-content:flex-end; margin-top:14px}
.appModalActions button{width:auto; padding:12px 14px; border-radius:14px; font-weight:950}

.otPos{ color: var(--green) !important; }
.otNeg{ color: var(--red) !important; }
.otZero{ color: rgba(255,255,255,.85) !important; }
/* === Home: probeer alles op 1 scherm te houden (zonder scroll) === */

/* Iets compacter spacing */
.card{ padding:14px; }
.row{ margin-bottom:10px; }
.sp{ height:8px; }

/* Timer iets kleiner op kleine hoogtes */
.bigTimer{ font-size: clamp(44px, 10.5vw, 92px); }

/* Datumchip iets compacter */
.timerDateValue{ padding:8px 12px; }

/* Knoppen iets lager */
.btnHalf{
  height:56px;
  font-size:16px;
}

/* Saldo kaart compacter */
.miniCard{ padding:12px; }
.miniCard .v{ font-size:36px; }

/* Extra agressief als hoogte klein is */
@media (max-height: 740px){
  .bigTimer{ font-size: clamp(40px, 10vw, 80px); }
  .btnHalf{ height:52px; }
  .miniCard .v{ font-size:32px; }
  .sp{ height:6px; }
}
/* ===== Kalender (UI) ===== */
.calGrid{
  display:grid;
  grid-template-columns:repeat(7, 1fr);
  gap:8px;
}


/* Header (M D W D V Z Z) */
.calHead{
  text-align:center;
  font-weight:950;
  font-size:12px;
  color:var(--muted);
  padding:4px 0;
  opacity:.9;
}

/* Lege vakjes */
.calBlank{
  opacity:.12;
  min-height:56px;
}

/* Dag-cel */
.calCell{
  position:relative;           /* nodig voor absolute badges */
  cursor:pointer;
  border:1px solid var(--line);
  background: rgba(255,255,255,.05);
  border-radius:14px;
  padding:10px;
  min-height:56px;
  overflow:hidden;             /* voorkomt overlap buiten vakje */
}

/* Dagnummer linksboven */
.calNum{
  position:absolute;
  top:4px;
  left:4px;
  font-weight:950;
  font-size:14px;
  opacity:.95;
  z-index:3;
  pointer-events:none;
}

/* Type-letter rechtsonder (W/R/Z/V/F) */
.calTypePill{
  position:absolute;
  bottom:4px;
  right:4px;
  font-size:11px;
  font-weight:900;
  padding:3px 7px;
  border-radius:999px;
  background: rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.14);
  letter-spacing:.5px;
  z-index:2;
  pointer-events:none;
}

/* Werk-uren linksonder (bv 8:30) */
.calWorkHours{
  position:absolute;
  bottom:7px;
  left:7px;
  font-size:12px;
  font-weight:900;
  opacity:.95;
  z-index:2;
  pointer-events:none;
}

/* 1 kleur per type */
.calWork{ 
  background: #2f8f5e;
}

.calRecup{ 
  background: #3f79ff;
}

.calVakantie{ 
  background: #e6a400;
}

.calZiekte{ 
  background: #c94343;
}

.calFeestdag{ 
  background: #374151; 
}

/* Compact op kleine schermhoogte */
@media (max-height: 760px){
  #tab3 .card{ padding:12px; }
  #tab3 .h2Row{ margin-bottom:6px; }
  #tab3 h2{ font-size:28px; }

  #tab3 .btnSmall{
    height:44px;
    padding:0 12px;
    border-radius:12px;
  }

  #tab3 .badge{
    padding:8px 10px;
    font-size:14px;
  }

  #tab3 .calGrid{ gap:6px; }

  #tab3 .calCell,
  #tab3 .calBlank{
    min-height:46px;
    padding:8px;
    border-radius:12px;
  }

  #tab3 .calHead{
    font-size:11px;
    padding:2px 0;
  }

  #tab3 .calNum{ font-size:13px; }
  #tab3 .calWorkHours{ font-size:11px; }
  #tab3 .calTypePill{ font-size:10px; padding:2px 6px; }
}
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.calLegendBottom{
  margin-top:20px;
  margin-bottom:20px;
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  gap:14px;
  font-weight:900;
}

.legendItem{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:14px;
  opacity:.95;
}

.legendDot{
  width:28px;
  height:28px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:950;
  color:#fff;
}
.legendItem{
  font-size:13px;
}

.legendDot{
  width:24px;
  height:24px;
  font-size:13px;
}
/* ===== Verrekenen modal overlay ===== */
#verrekenModal{
  position: fixed;
  inset: 0;
  display: none;              /* JS zet dit naar flex */
  align-items: center;
  justify-content: center;
  padding: 18px;
  z-index: 9999;

  background: rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

#verrekenModal .modalCard{
  position: relative;   /* dit toevoegen */
}
/* Verrekenen modal form layout */
#verrekenModal .modalCard label{
  display:block;
  margin-top:12px;
}

#verrekenModal .modalCard input{
  display:block;
  width:100%;
  box-sizing:border-box;
}

/* de kaart zelf */
#verrekenModal .modalCard{
  width: min(92vw, 420px);
  max-height: 85vh;
  overflow: auto;

  border-radius: 22px;
  border: 1px solid var(--line);
  background: #1a0a10;
  box-shadow: 0 20px 70px rgba(0,0,0,.6);
  padding: 16px;
}
.modalCloseX{
  position:absolute;
  top:14px;
  right:18px;
  background:none;
  border:none;
  font-size:28px;
  font-weight:700;
  cursor:pointer;
  color:white;
}
.calDotVerrek{
  position:absolute;
  bottom:3px;
  left:3px;
  width:9px;
  height:9px;
  border-radius:50%;
  background: rgba(0,255,120,.9);
  box-shadow: 0 0 0 2px rgba(0,0,0,.25);
}

</style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="title">

        <div class="app-header">
          <div class="app-header-left">
            <img src="ST-logo.png" alt="Shift Tap logo" class="app-logo">
            <div class="app-title-wrap">
              <h1>Shift-Tap</h1>
              <div class="sub">v2.0.0</div>
            </div>
          </div>

          <div class="app-header-actions">
            <button id="btnHome" class="btnIcon" aria-label="Home">üè†</button>
<button id="btnNavCalendar" class="btnIcon" aria-label="Kalender">üìÖ</button>
            <button id="btnOpenHistory" class="btnIcon" aria-label="Historiek">üìú</button>
            <button id="btnOpenSettings" class="btnIcon" aria-label="Instellingen">‚öôÔ∏è</button>
          </div>
        </div>

      </div>
    </div>

    <div id="tab1" class="tab">
      <div class="card">

        <div class="timerTopLine">
          <span id="todayPill" class="timerDateValue">-</span>
        </div>

        <div id="timer" class="bigTimer">00:00:00</div>
        <div id="status" class="status"></div>

        <div class="row">
          <button class="btnStart btnHalf" id="btnStart" data-i18n="start">Start</button>
          <button class="btnPause btnHalf" id="btnPause" data-i18n="pause_stop">Stop</button>
        </div>

        <div class="sp"></div>

        <div class="row">
<button class="btnSave btnHalf" id="btnSave" data-i18n="save">Opslaan</button>
          <button class="btnRecup btnHalf" id="btnRecup" data-i18n="recup">Recup</button>
        </div>

  <div class="miniCard" style="margin-top:12px;">
  <div class="k" data-i18n="overtime">Saldo overuren</div>
  <div id="overtimeSaldo" class="v" style="font-size:28px; font-weight:900; margin-top:6px;">0:00</div>
<button class="btnSmall" id="btnVerreken" type="button"
        style="margin-top:14px; margin-left:auto; display:block;"
        data-i18n="settle">
</button>
</div>
<!-- ===== Verrekenen modal ===== -->
<div id="verrekenModal" class="modalBack" style="display:none;">
  <div class="modalCard">
  <button id="btnCloseVerreken" class="modalCloseX" type="button">‚úï</button>
 <h2 data-i18n="overtime_settled">Overuren verrekend</h2>
<p class="modalHint" data-i18n="settle_hint">
  Heb je overuren uitbetaald gekregen? Registreer ze hier zodat ze van je saldo worden afgetrokken.
</p>

 <label for="verrekenAmount" data-i18n="hours_amount_hhmm">Aantal uren (HH:MM)</label>
 <input id="verrekenAmount" type="text"
       inputmode="numeric"
       maxlength="5"
       placeholder="00:00">
       

<label for="verrekenDate" data-i18n="lbl_date">Datum</label>
    <input id="verrekenDate" type="date">
    <div class="modalActions">
<button type="button" id="btnSaveVerrekening" class="btnGreen" data-i18n="save">Opslaan</button>
</div>

 
  </div>
</div>
<div class="grid3" style="margin-top:12px;">
  <div class="miniCard">
    <div class="k" data-i18n="today_work">Vandaag</div>
    <div class="v" id="todayWork">0:00</div>
  </div>
  <div class="miniCard">
    <div class="k" data-i18n="week_work">Deze week</div>
    <div class="v" id="weekWork">0:00</div>
  </div>
</div>
<div class="miniCard" style="margin-top:12px; position:relative;">
  <div class="k" data-i18n="vac_taken">Opgenomen vakantie</div>
  <div class="v" id="vacTaken">0</div>
</div>

    </div>
</div>
<!-- ================= TAB 2 ================= -->
<div id="tab2" class="tab" style="display:none;">
  <div class="card">
    <div class="h2Row">
      <h2 data-i18n="history_title">Historiek</h2>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btnSmall" id="btnAddManual" data-i18n="manual" type="button">+ Handmatig</button>
      </div>
    </div>

    <div class="muted" data-i18n="history_hint" data-i18n-html="1">
      Vergeten uit te tikken?<br>Voeg handmatig toe.
    </div>

    <div class="list" id="historyList"></div>
  </div>
</div>

<!-- ================= TAB 3 ================= -->
<div id="tab3" class="tab" style="display:none;">
  <div class="card">
    <div class="h2Row">
      <h2 data-i18n="calendar">Kalender</h2>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btnSmall" id="calPrev" type="button">‚óÄ</button>
        <span class="badge" id="calLabel">-</span>
        <button class="btnSmall" id="calNext" type="button">‚ñ∂</button>
      </div>
    </div>

    <div class="hr"></div>

    <div id="calGrid" class="calGrid"></div>

<div class="calLegendBottom">
  <div class="legendItem">
    <span class="legendDot calWork" data-letter-type="Werk"></span>
    <span data-i18n="work">Werk</span>
  </div>

  <div class="legendItem">
    <span class="legendDot calRecup" data-letter-type="Recup"></span>
    <span data-i18n="recup">Recup</span>
  </div>

  <div class="legendItem">
    <span class="legendDot calFeestdag" data-letter-type="Feestdag"></span>
    <span data-i18n="holiday">Feestdag</span>
  </div>

  <div class="legendItem">
    <span class="legendDot calZiekte" data-letter-type="Ziekte"></span>
    <span data-i18n="sick">Ziekte</span>
  </div>

  <div class="legendItem">
    <span class="legendDot calVakantie" data-letter-type="Vakantie"></span>
    <span data-i18n="vacation">Vakantie</span>
  </div>
</div>
  </div>
</div>

<!-- ================= TAB 4 ================= -->
<div id="tab4" class="tab" style="display:none;">
  <div class="card">

    <div class="h2Row">
      <span class="badge" id="onlineBadge" data-i18n="status_online">Status: -</span>
    </div>

    <div class="hr"></div>


    <!-- Taal -->
    <label for="langSelect" data-i18n="language">Taal</label>
    <select id="langSelect">
      <option value="nl">Nederlands</option>
      <option value="en">English</option>
      <option value="fr">Fran√ßais</option>
    </select>

    <div class="sp"></div>

    <!-- Start saldo -->
    <label for="startSaldoInput" data-i18n="start_saldo">
      Start saldo overuren (u:min)
    </label>
    <input id="startSaldoInput" type="text" value="0:00" placeholder="60:00" />

    <div class="sp"></div>

    <!-- Pauze -->
    <label for="pauseMin" data-i18n="default_pause">
      Standaard pauze (min)
    </label>
    <input id="pauseMin" type="number" min="0" step="5" value="30" />

    <div class="hr"></div>

    <!-- Normale werkdag -->
    <label for="normDayInput" data-i18n="norm_day">
      Duur normale werkdag (u:min)
    </label>
    <input id="normDayInput" type="text" value="7:30" placeholder="7:30" />

    <div class="row" style="margin-top:16px;">
      <button class="btnGhost" id="btnSaveSettings" data-i18n="settings">
        Opslaan
      </button>
    </div>

    <div class="hr"></div>

    <!-- Cloud -->
    <div class="h2Row">
      <div>
        <div class="muted" style="font-weight:950;" data-i18n="cloud_title">
          Google login + Cloud sync
        </div>
<div class="muted2" id="loginNote"></div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btnGhost" id="btnGoogleLogin" data-i18n="login_google">
        Inloggen met Google
      </button>
      <button class="btnGhost" id="btnGoogleLogout" style="display:none;" data-i18n="logout_google">
        Uitloggen
      </button>
    </div>
    <div class="muted2" id="loginNote"></div>

    <div class="sp"></div>

    <div class="row">
      <button class="btnGhost" id="btnCloudPull" data-i18n="cloud_download">
        Cloud ‚Üí toestel
      </button>
      <button class="btnGhost" id="btnCloudPush" data-i18n="cloud_upload">
        Toestel ‚Üí cloud
      </button>
    </div>


    <div class="footer">
      Shift-Tap ‚Äì Made by <b>Kim Gijs</b>
    </div>

  </div>
</div>

<!-- MODAL -->
  <div class="modalBack" id="modalBack">
<div class="modal">
  <div class="h2Row" style="align-items:center; gap:10px;">
    <div>
      <h3 id="modalTitle" data-i18n="modal_add_title">Handmatig toevoegen</h3>
      <div class="muted2" data-i18n="modal_hint" style="font-weight:600; margin-top:6px;">
        Vergeet uit te tikken? Voeg gewoon de juiste tijden toe.
      </div>
    </div>

<button class="modalCloseBtn" id="btnCloseModal" type="button">√ó</button>
  </div>

  <div class="sp"></div>

  <div class="row2">
    <div>
      <label for="mDate" data-i18n="lbl_date">Datum</label>
      <input id="mDate" type="date">
    </div>

    <div>
      <label for="mType" data-i18n="lbl_type">Type</label>
<select id="mType">
  <option value="Werk" data-i18n="work_label">Werk</option>
  <option value="Recup" data-i18n="recup">Recup</option>
  <option value="Ziekte" data-i18n="sick">Ziekte</option>
  <option value="Vakantie" data-i18n="vacation">Vakantie</option>
  <option value="Feestdag" data-i18n="holiday">Feestdag</option>
</select>
    </div>
  </div>

  <div class="row3">
    <div>
      <label for="mStart" data-i18n="lbl_start">Start (HH:MM)</label>
      <input id="mStart" type="time">
    </div>

    <div>
      <label for="mEnd" data-i18n="lbl_end">Einde (HH:MM)</label>
      <input id="mEnd" type="time">
    </div>

    <div>
      <label for="mPause" data-i18n="lbl_pause">Pauze (min)</label>
      <input id="mPause" type="number" min="0" step="5" value="30">
    </div>
  </div>

  <div class="sp"></div>

  <label for="mNote" data-i18n="lbl_note">Opmerking (optioneel)</label>
  <textarea id="mNote" rows="3" data-i18n-placeholder="ph_note"
    placeholder="bv. Garage na rit, file, wachten op klant..."></textarea>
    
  <div class="modalActions">

<button class="btnGreen" id="btnSaveModal" type="button" data-i18n="save"></button>

  </div>
</div>
    </div>
<!-- Firebase CDN (mag blijven staan, ook al gebruik je het nog niet actief) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

</div>  <!-- einde van je wrap / tabs -->

<!-- HIER PLAKKEN -->
<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- ===== Dag detail overlay ===== -->
<div id="dayOverlay" class="overlay" style="display:none;">
  <div class="modal">
    <div class="modalTop">
      <div class="modalTitle" id="dayTitle">-</div>
      <button class="btnIcon" id="dayClose" type="button">‚úï</button>
    </div>

    <div class="hr"></div>
    <div id="dayBody" class="modalBody"></div>
    <div class="hr"></div>

    <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
<button class="btnSmall" id="dayEdit" type="button"
        data-i18n="edit_btn" data-i18n-html="1"
        data-i18n-aria="edit_aria" aria-label="Bewerken">‚úé Bewerken</button>
    </div>
  </div>
</div>

<script>
(() => {
  /* =========================
     ShiftTap (try Gmail)
     ========================= */
  const APP_ID = "shifttap";
const APP_CHANNEL = "stable_try_gmailv1";
const APP_VERSION = "2.0.0";

const STORE_KEY = `${APP_ID}_state_${APP_CHANNEL}`;
const META_KEY  = `${APP_ID}_meta_${APP_CHANNEL}`;

const NORM_MIN  = 7 * 60 + 30;
const RECUP_MIN = 7 * 60 + 30;

// =========================
// Cloud sync (Google login) via Firebase
// Setup (phone-friendly):
// - Create Firebase project
// - Enable Authentication -> Google
// - Create Firestore database
// - Paste firebaseConfig below
// =========================


// Firebase config is not a secret, but Firestore rules must be locked.
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCkK45tqlORcpyIkVVsD5sJA6CRx4guad0",
  authDomain: "shifttap-cloud.firebaseapp.com",
  projectId: "shifttap-cloud",
  storageBucket: "shifttap-cloud.firebasestorage.app",
  messagingSenderId: "818538130643",
  appId: "1:818538130643:web:2614157b0d6a767deb3826"
};

let fbApp = null;
let fbAuth = null;
let fbDb = null;

function firebaseConfigured(){
  return !!(FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.projectId);
}


async function ensureFirebase(){
  if(!firebaseConfigured()) return false;
  if(fbApp && fbAuth && fbDb) return true;

  fbApp = firebase.initializeApp(FIREBASE_CONFIG);
  fbAuth = firebase.auth();
  fbDb = firebase.firestore();

  await fbAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  return true;
}

/* =========================
   Cloud sync (Google login)
   - Mobile friendly: redirect login
   ========================= */
const elLoginNote     = document.getElementById("loginNote");
const btnGoogleLogin  = document.getElementById("btnGoogleLogin");
const btnGoogleLogout = document.getElementById("btnGoogleLogout");
const btnCloudPull    = document.getElementById("btnCloudPull");
const btnCloudPush    = document.getElementById("btnCloudPush");

function setCloudUiEnabled(enabled){
  if(btnGoogleLogin)  btnGoogleLogin.disabled  = !enabled;
  if(btnGoogleLogout) btnGoogleLogout.disabled = !enabled;
  if(btnCloudPull)    btnCloudPull.disabled    = !enabled;
  if(btnCloudPush)    btnCloudPush.disabled    = !enabled;
}

function setLoginUi(user){
  const loggedIn = !!user;
  if(btnGoogleLogin)  btnGoogleLogin.style.display  = loggedIn ? "none" : "inline-flex";
  if(btnGoogleLogout) btnGoogleLogout.style.display = loggedIn ? "inline-flex" : "none";
  if(elLoginNote){
    elLoginNote.textContent = loggedIn
      ? `‚úÖ Ingelogd: ${user.email || user.displayName || "Google"}`
      : `Niet ingelogd.`;
  }
}






  let calYear  = new Date().getFullYear();
let calMonth = new Date().getMonth();

  /* =========================
     i18n (3-talig)
     ========================= */
  const LANG = {

    nl: {
      // --- Modal (handmatig) ---
      history_title: "Historiek",
      history_hint: "Vergeten uit te tikken?<br>Voeg handmatig toe.",
      modal_add_title: "Handmatig toevoegen",
      modal_edit_title: "Entry bewerken",
      modal_hint: "Vergeet uit te tikken? Voeg gewoon de juiste tijden toe.",
      btn_close: "Sluiten",
      btn_save: "Opslaan",
      btn_delete: "Verwijderen",

      lbl_date: "Datum",
      lbl_type: "Type",
      lbl_start: "Start (HH:MM)",
      lbl_end: "Einde (HH:MM)",
      lbl_pause: "Pauze (min)",
      lbl_note: "Opmerking (optioneel)",
      ph_note: "bv. Garage na rit, file, wachten op klant...",

      err_choose_date: "Kies een datum.",
      err_fill_times: "Vul start en einde in (of kies Recup).",
      confirm_delete_entry: "Deze entry verwijderen?",
      backup_last: "Laatste backup",
      backup_never: "nooit",
      settings: "Opslaan",
      tab_day: "Dag-Shift",
      tab_history: "Historiek",
      recup: "Recup",
      start: "Start",
      pause_stop: "Stop",
      save: "Opslaan",
      manual: "+ Handmatig",
      backup: "Backup",
      import_json: "Import JSON",
      backup_tip: "Tip: Maak regelmatig backup.",
      language: "Taal",
      start_saldo: "Start saldo overuren (u:min)",
      default_pause: "Standaard pauze (min)",
      norm_day: "Duur normale werkdag (u:min)",
      cloud_title: "Google login + Cloud sync",
      cloud_not_available: "Nog niet mogelijk.",
      login_google: "Inloggen met Google",
      logout_google: "Uitloggen",
      cloud_download: "Backup downl",
      cloud_upload: " Maak Backup",
      settle_hint: "Heb je overuren uitbetaald gekregen? Registreer ze hier zodat ze van je saldo worden afgetrokken.",

      today_work: "Vandaag (werk)",
      week_work: "Deze week (werk)",
      overtime: "Saldo overuren",
      minutes: "min",
      hours: "u",
      days: "dag",
      calendar: "Kalender",
      vac_taken: "Opgenomen vakantie",

      status_busy: "Bezig...",
      status_paused: "Gepauzeerd",
      status_not_started: "Niet gestart",
      cloud_logged_in: "Ingelogd:",
cloud_not_logged: "Niet ingelogd.",
cloud_login_error: "Google login fout",

      recup_line: "RECUP - gaat van overuren af",
      net_line: "netto",
      pause_line: "pauze",
      work_label: "WERK",
      sick: "Ziekte",
vacation: "Vakantie",
holiday: "Feestdag",
note_label: "Opmerking",
edit_btn: "‚úé Bewerken",
edit_aria: "Bewerken",
work: "Werk",
verrek_none: "Geen verrekening gevonden op die dag.",
  verrek_deleted: "Verrekening verwijderd ‚úì",
  btn_add_manual: "Toevoegen",
  settle: "Verrekenen",
  overtime_settled: "Overuren verrekend",
hours_amount_hhmm: "Aantal uren (HH:MM)",

      err_start_saldo_format: "Start saldo moet in formaat u:min zijn, bv 60:00",
      err_normday_format: "Norm dag moet in formaat u:min zijn, bv 7:30",
      settings_saved: "Instellingen opgeslagen",
      status_online: "Status: online",
      status_offline: "Status: offline",
      err_bad_json: "Ongeldig JSON bestand.",
      err_timer_short: "Timer is te kort. Gebruik START of + Handmatig."
    },

    en: {
      history_title: "History",
      history_hint: "Forgot to clock out?<br>Add it manually.",
      modal_add_title: "Add manually",
      modal_edit_title: "Edit entry",
      modal_hint: "Forgot to clock out? Just add the correct times.",
      btn_close: "Close",
      btn_save: "Save",
      btn_delete: "Delete",

      lbl_date: "Date",
      lbl_type: "Type",
      lbl_start: "Start (HH:MM)",
      lbl_end: "End (HH:MM)",
      lbl_pause: "Break (min)",
      lbl_note: "Note (optional)",
      ph_note: "e.g. Garage after route, traffic, waiting for customer...",

      err_choose_date: "Choose a date.",
      err_fill_times: "Fill in start and end (or choose Comp Day).",
      confirm_delete_entry: "Delete this entry?",
      backup_last: "Last backup",
      backup_never: "never",
      settings: "Save",
      tab_day: "Day Shift",
      tab_history: "History",
      recup: "Comp Day",
      start: "Start",
      pause_stop: "Stop",
      save: "Save",
      manual: "+ Manual",
      backup: "Backup",
      import_json: "Import JSON",
      backup_tip: "Tip: Make regular backups.",
      language: "Language",
      start_saldo: "Start overtime balance (h:mm)",
      default_pause: "Default break (min)",
      norm_day: "Normal workday duration (h:mm)",
      cloud_title: "Google login + Cloud sync",
      cloud_not_available: "Not available yet.",
      login_google: "Login with Google",
      logout_google: "Logout",
      cloud_upload: "Create backup",
cloud_download: "Restore backup",
      settle_hint: "Have your overtime hours been paid out? Record them here to deduct them from your balance.",
      cloud_logged_in: "Logged in:",
cloud_not_logged: "Not logged in.",
cloud_login_error: "Google login error",

      today_work: "Today (work)",
      week_work: "This week (work)",
      overtime: "Overtime balance",
      minutes: "min",
      hours: "h",
      days: "day",
      work_label: "WORK",
      sick: "Sick leave",
vacation: "Vacation",
holiday: "Public holiday",
calendar: "Calendar",
vac_taken: "Vacation taken",
note_label: "Note",
edit_btn: "‚úé Edit",
edit_aria: "Edit",
work: "Work",
verrek_none: "No settlement found on that day.",
  verrek_deleted: "Settlement removed ‚úì",
  btn_add_manual: "Add manual",
  settle: "Deduct",
  overtime_settled: "Overtime settled",
hours_amount_hhmm: "Number of hours (HH:MM)",


      status_busy: "Running...",
      status_paused: "Paused",
      status_not_started: "Not started",

      recup_line: "COMP DAY - subtracts from overtime",
      net_line: "net",
      pause_line: "break",

      err_start_saldo_format: "Start balance must be in h:mm format, e.g. 60:00",
      err_normday_format: "Daily norm must be in h:mm format, e.g. 7:30",
      settings_saved: "Settings saved",
      status_online: "Status: online",
      status_offline: "Status: offline",
      err_bad_json: "Invalid JSON file.",
      err_timer_short: "Timer is too short. Use START or + Manual."
    },

    fr: {
      history_title: "Historique",
      history_hint: "Tu as oubli√© de pointer?<br>Ajoute-le manuellement.",
      modal_add_title: "Ajout manuel",
      modal_edit_title: "Modifier l‚Äôentr√©e",
      modal_hint: "Tu as oubli√© de pointer ? Ajoute simplement les bonnes heures.",
      btn_close: "Fermer",
      btn_save: "Enregistrer",
      btn_delete: "Supprimer",
      cloud_logged_in: "Connect√© :",
cloud_not_logged: "Non connect√©.",
cloud_login_error: "Erreur de connexion Google",

      lbl_date: "Date",
      lbl_type: "Type",
      lbl_start: "D√©but (HH:MM)",
      lbl_end: "Fin (HH:MM)",
      lbl_pause: "Pause (min)",
      lbl_note: "Remarque (optionnel)",
      ph_note: "ex. Garage apr√®s tourn√©e, embouteillage, attente client...",

      err_choose_date: "Choisis une date.",
      err_fill_times: "Remplis d√©but et fin (ou choisis Jour de r√©cup).",
      confirm_delete_entry: "Supprimer cette entr√©e ?",
      backup_last: "Derni√®re sauvegarde",
      backup_never: "jamais",
      settings: "Enregistrer",
      tab_day: "Jour de travail",
      tab_history: "Historique",
      recup: "Jour de r√©cup",
      start: "D√©marrer",
      pause_stop: "Arr√™ter",
      save: "Enregistrer",
      manual: "+ Manuel",
      backup: "Sauvegarde",
      import_json: "Importer JSON",
      backup_tip: "Astuce : faites r√©guli√®rement une sauvegarde.",
      language: "Langue",
      start_saldo: "Solde initial heures sup (h:mm)",
      default_pause: "Pause par d√©faut (min)",
      norm_day: "Dur√©e normale de travail (h:mm)",
      cloud_title: "Connexion Google + synchronisation cloud",
      cloud_not_available: "Pas encore disponible.",
      login_google: "Connexion Google",
      logout_google: "D√©connexion",
      cloud_upload: "Sauvegarde",
cloud_download: "Restaurer",
      settle_hint: "Des heures suppl√©mentaires ont √©t√© pay√©es ? Enregistre-les ici pour les d√©duire de ton solde.",

      today_work: "Aujourd‚Äôhui (travail)",
      week_work: "Cette semaine (travail)",
      overtime: "Solde heures sup",
      minutes: "min",
      hours: "h",
      days: "jour",
      work_label: "TRAVAIL",
      work: "Travail",
      sick: "Maladie",
vacation: "Vacances",
holiday: "Jour f√©ri√©",
calendar: "Calendrier",
vac_taken: "Cong√©s pris",
note_label: "Remarque",
edit_btn: "‚úé Modifier",
edit_aria: "Modifier",
verrek_none: "Aucune r√©gularisation trouv√©e ce jour-l√†.",
  verrek_deleted: "R√©gularisation supprim√©e ‚úì",
  btn_add_manual: "Ajouter",
  settle: "Compenser",
  overtime_settled: "Heures suppl√©mentaires r√©gl√©es",
hours_amount_hhmm: "Nombre d'heures (HH:MM)",

      status_busy: "En cours...",
      status_paused: "En pause",
      status_not_started: "Pas encore d√©marr√©",

      recup_line: "JOUR DE R√âCUP - d√©duit des heures sup",
      net_line: "net",
      pause_line: "pause",

      err_start_saldo_format: "Le solde initial doit √™tre au format h:mm, ex. 60:00",
      err_normday_format: "La norme/jour doit √™tre au format h:mm, ex. 7:30",
      settings_saved: "Enregistrer",
      status_online: "Statut : en ligne",
      status_offline: "Statut : hors ligne",
      err_bad_json: "Fichier JSON invalide.",
      err_timer_short: "Le timer est trop court. Utilise D√âMARRER ou + Manuel."
    }

  };

  /* =========================
     i18n engine
     ========================= */
  let currentLang = localStorage.getItem("lang") || "nl";
  if(!LANG[currentLang]) currentLang = "nl";

  function t(key){
    return LANG[currentLang]?.[key] ?? key;
  }

  function applyLang(){

  // gewone tekst
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.dataset.i18n;
    if(el.dataset.i18nHtml) el.innerHTML = t(key);
    else el.textContent = t(key);
  });

  // placeholders
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
    const key = el.dataset.i18nPlaceholder;
    el.setAttribute("placeholder", t(key));
  });

  // aria-label (voor icon knoppen zoals bewerken)
  document.querySelectorAll("[data-i18n-aria]").forEach(el=>{
    const key = el.dataset.i18nAria;
    el.setAttribute("aria-label", t(key));
  });

  const sel = document.getElementById("langSelect");
  if(sel) sel.value = currentLang;
}


document.getElementById("langSelect")?.addEventListener("change", e=>{
  currentLang = e.target.value;
  localStorage.setItem("lang", currentLang);
  applyLang();
});
const verrekenInput = document.getElementById("verrekenAmount");

verrekenInput?.addEventListener("input", (e) => {
  let v = e.target.value.replace(/\D/g, ""); // enkel cijfers
  if(v.length > 4) v = v.slice(0,4);

  if(v.length >= 3){
    let uren = v.slice(0,2);
    let min = v.slice(2);

    if(parseInt(min) > 59){
      min = "59";
    }

    v = uren + ":" + min;
  }

  e.target.value = v;
});

  
  /* =========================
     Toast + Confirm
     ========================= */
  function showToast(message, type="warn"){
    const el = document.getElementById("toast");
    if(!el) return;
    el.textContent = message;
    el.className = "toast " + type;
    el.classList.add("show");
    setTimeout(() => el.classList.remove("show"), 2200);
  }

  function openConfirm(message, onOk){
    const overlay = document.getElementById("appModalOverlay");
    const body    = document.getElementById("appModalBody");
    const btnOk   = document.getElementById("appModalOk");
    const btnCan  = document.getElementById("appModalCancel");

    if(!overlay || !btnOk || !btnCan){
      if(confirm(message)){
        if(typeof onOk === "function") onOk();
      }
      return;
    }

    if(body) body.textContent = message;
    overlay.classList.add("show");

    const cleanup = () => {
      overlay.classList.remove("show");
      btnOk.onclick = null;
      btnCan.onclick = null;
      overlay.onclick = null;
      document.removeEventListener("keydown", escHandler);
    };

    const escHandler = (e) => { if(e.key === "Escape") cleanup(); };

    btnOk.onclick = () => { cleanup(); if(typeof onOk === "function") onOk(); };
    btnCan.onclick = () => cleanup();
    overlay.onclick = (e) => { if(e.target === overlay) cleanup(); };
    document.addEventListener("keydown", escHandler);
  }

  /* =========================
     State + Meta defaults
     ========================= */
  const defaultState = () => ({
  settings: { startSaldoMin: 0, normDayMin: NORM_MIN, lang: "nl" },
  timer:    { running: false, startMs: null, accMs: 0 },
  entries:  [],
  verrekeningen: [],          
  overtimePaidMinutes: 0      
});

  const defaultMeta = () => ({
    lastBackupAt:   null,
    lastBackupName: null
  });

  function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    if(!s.settings) s.settings = { startSaldoMin: 0, normDayMin: NORM_MIN, lang:"nl" };
    if(!s.timer)    s.timer    = { running:false, startMs:null, accMs:0 };
    if(!Array.isArray(s.entries)) s.entries = [];

    
    if(!Array.isArray(s.verrekeningen)) s.verrekeningen = [];
    if(typeof s.overtimePaidMinutes !== "number") s.overtimePaidMinutes = 0;

    return s;
  }catch(e){ return defaultState(); }
}

  function loadMeta(){
    try{
      const raw = localStorage.getItem(META_KEY);
      if(!raw) return defaultMeta();
      const m = JSON.parse(raw);
      return m || defaultMeta();
    }catch(e){ return defaultMeta(); }
  }

  let state = loadState();
  let meta  = loadMeta();

  function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
  function saveMeta(){ localStorage.setItem(META_KEY, JSON.stringify(meta)); }

  /* =========================
     DOM refs
     ========================= */
  const elTodayPill       = document.getElementById("todayPill");
  const elTimer           = document.getElementById("timer");
  const elStatus          = document.getElementById("status");
  const elPauseMin        = document.getElementById("pauseMin");
  const elNormDayInput    = document.getElementById("normDayInput");

  const elTodayWork       = document.getElementById("todayWork");
  const elWeekWork        = document.getElementById("weekWork");
  const elOvertimeSaldo   = document.getElementById("overtimeSaldo");
const elVacTaken = document.getElementById("vacTaken");

  const elHistoryList     = document.getElementById("historyList");

  const btnStart          = document.getElementById("btnStart");
  const btnPause          = document.getElementById("btnPause");
  const btnSave           = document.getElementById("btnSave");
  const btnRecup          = document.getElementById("btnRecup");

  const btnAddManual      = document.getElementById("btnAddManual");

  const elOnlineBadge     = document.getElementById("onlineBadge");
  const elLastBackupText  = document.getElementById("lastBackupText");
  const btnBackupNow      = document.getElementById("btnBackupNow");
  const elStartSaldoInput = document.getElementById("startSaldoInput");

  const btnSaveSettings   = document.getElementById("btnSaveSettings");

  const fileImport2       = document.getElementById("fileImport2");

  const modalBack         = document.getElementById("modalBack");
  const modalTitle        = document.getElementById("modalTitle");
  const btnCloseModal     = document.getElementById("btnCloseModal");
  const btnSaveModal      = document.getElementById("btnSaveModal");
  const btnDeleteInModal  = document.getElementById("btnDeleteInModal");
  const mDate             = document.getElementById("mDate");
  const mType             = document.getElementById("mType");
  const mStart            = document.getElementById("mStart");
  const mEnd              = document.getElementById("mEnd");
  const mPause            = document.getElementById("mPause");
  const mNote             = document.getElementById("mNote");

  const langSelect        = document.getElementById("langSelect");
  
  const elCalGrid  = document.getElementById("calGrid");
  const elCalLabel = document.getElementById("calLabel");
  const btnCalPrev = document.getElementById("calPrev");
  const btnCalNext = document.getElementById("calNext");

  /* =========================
     Boot lang from settings
     ========================= */
  currentLang = state.settings?.lang || currentLang || "nl";
  if(langSelect) langSelect.value = currentLang;

  /* =========================
     Tabs navigation
     ========================= */
  function showTab(id){
    document.querySelectorAll(".tab").forEach(t => t.style.display = "none");
    const target = document.getElementById(id);
    if(target) target.style.display = "block";
  }
  /* ===== Dag-detail (UI refs) ===== */
const dayOverlay  = document.getElementById("dayOverlay");
const dayTitle    = document.getElementById("dayTitle");
const dayBody     = document.getElementById("dayBody");
const dayClose    = document.getElementById("dayClose");
const dayEdit     = document.getElementById("dayEdit");
const verrekenModal = document.getElementById("verrekenModal");



document.getElementById("btnVerreken")?.addEventListener("click", () => {
  const d = document.getElementById("verrekenDate");
  if(d) d.value = ymd(new Date());

  const a = document.getElementById("verrekenAmount");
  if(a && !a.value) a.value = "0:00";

  if(verrekenModal) verrekenModal.style.display = "flex";
});

document.getElementById("btnCloseVerreken")?.addEventListener("click", () => {
  if(verrekenModal) verrekenModal.style.display = "none";
});

// klik op de donkere achtergrond = sluiten
verrekenModal?.addEventListener("click", (e) => {
  if(e.target === verrekenModal) verrekenModal.style.display = "none";
});


  document.getElementById("btnOpenHistory")?.addEventListener("click", () => showTab("tab2"));
  document.getElementById("btnHome")?.addEventListener("click", () => showTab("tab1"));
  document.getElementById("btnOpenSettings")?.addEventListener("click", () => showTab("tab4"));
document.getElementById("btnNavCalendar")?.addEventListener("click", () => {
  showTab("tab3");
  renderCalendar();
});
  btnCalPrev?.addEventListener("click", ()=>{
  calMonth--;
  if(calMonth < 0){
    calMonth = 11;
    calYear--;
  }
  renderCalendar();
});

btnCalNext?.addEventListener("click", ()=>{
  calMonth++;
  if(calMonth > 11){
    calMonth = 0;
    calYear++;
  }
  renderCalendar();
});

  /* =========================
     Helpers
     ========================= */
  const pad2 = n => String(n).padStart(2,"0");
  const ymd  = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  
  const dmy  = d => `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
  function calLocale(){
    return currentLang==="fr" ? "fr-FR" : currentLang==="en" ? "en-GB" : "nl-BE";
  }
  
function escapeHtml(str){
  if(!str) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function typeAbbr(type){
  const abbr = {
    nl: { Werk:"W",  Recup:"R",   Ziekte:"Z", Vakantie:"V", Feestdag:"F" },
    fr: { Werk:"TR", Recup:"JDR", Ziekte:"M", Vakantie:"V", Feestdag:"JF" },
    en: { Werk:"W",  Recup:"CD",  Ziekte:"SL", Vakantie:"V", Feestdag:"PH" }
  };

  const map = abbr[currentLang] || abbr.nl;
  return map[type] || "";
}

function updateLegendLetters(){
  document.querySelectorAll("[data-letter-type]").forEach(el=>{
    const type = el.dataset.letterType;
    el.textContent = typeAbbr(type);
  });
}

  function dayHeaders(){
    // Maandag eerst
    if(currentLang==="fr") return ["L","M","M","J","V","S","D"];
    if(currentLang==="en") return ["M","T","W","T","F","S","S"];
    return ["M","D","W","D","V","Z","Z"];
  }

  function entryForDate(dateStr){
    // 1 entry per datum: neem de ‚Äúlaatste‚Äù (createdAt) als er toch meerdere zouden zijn
    const list = state.entries
      .filter(e=>!e.deletedAt && e.date===dateStr)
      .slice()
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    return list[0] || null;
  }

  function calClassForType(type){
    if(type==="Werk") return "calWork";
    if(type==="Recup") return "calRecup";
    if(type==="Vakantie") return "calVakantie";
    if(type==="Ziekte") return "calZiekte";
    if(type==="Feestdag") return "calFeestdag";
    return "";
  }

  function calInfoText(e){
  if(!e) return "";

  if(e.type === "Werk"){
    return `${formatHM(e.netMin||0)}`;
  }

  const map = {
    "Recup": "recup",
    "Ziekte": "sick",
    "Vakantie": "vacation",
    "Feestdag": "holiday"
  };

  const key = map[e.type];
  if(key) return t(key).toUpperCase();

  return (e.type || "").toUpperCase();
}

function renderCalendar(){
  if(!elCalGrid || !elCalLabel) return;

  const first = new Date(calYear, calMonth, 1);
  const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();

  // maandag = 0
  const startDay = (first.getDay() + 6) % 7;

  elCalLabel.textContent = first.toLocaleDateString(calLocale(), { month:"long", year:"numeric" });
  elCalGrid.innerHTML = "";

  // Headers (M D W D V Z Z)
  dayHeaders().forEach(ch=>{
    const hd = document.createElement("div");
    hd.className = "calHead";
    hd.textContent = ch;
    elCalGrid.appendChild(hd);
  });

  // blanks v√≥√≥r dag 1
  for(let i=0;i<startDay;i++){
    const blank = document.createElement("div");
    blank.className = "calBlank";
    elCalGrid.appendChild(blank);
  }

  for(let day=1; day<=daysInMonth; day++){
    const dateStr = ymd(new Date(calYear, calMonth, day));
    const e = entryForDate(dateStr);

    const cell = document.createElement("div");

    // class + kleur
    cell.className = "calCell";
    if(e){
      const cls = calClassForType(e.type);
      if(cls) cell.classList.add(cls);
    }else{
      cell.classList.add("calEmpty");
    }

    // type letter
    const pill = e ? `<div class="calTypePill">${typeAbbr(e.type)}</div>` : "";

    // uren tonen (alleen bij werk)
    const hours = "";

    // verrekening dot (ook als er geen entry is)
    const vMins = (Array.isArray(state.verrekeningen) ? state.verrekeningen : [])
      .filter(v => !v.deletedAt && v.date === dateStr)
      .reduce((s,x)=> s + (x.minutes||0), 0);

    const dot = vMins > 0 ? `<span class="calDotVerrek" title="Verrekend: ${formatHM(vMins)}"></span>` : "";

    cell.innerHTML = `
      ${pill}
      <div class="calNum">${day}</div>
      ${hours}
      ${dot}
    `;

    cell.addEventListener("click", () => openDayDetail(dateStr));
    elCalGrid.appendChild(cell);
  }
}

function closeDayDetail(){
  if(dayOverlay) dayOverlay.style.display = "none";
}

function formatHM(min){
  const sign = min < 0 ? "-" : "";
  const a = Math.abs(min);
  const h = Math.floor(a/60);
  const m = a%60;
  return `${sign}${h}:${pad2(m)}`;
}

// ===== TOEVOEGING VERREKENINGEN START =====
// ---- verrekening verwijderen (enkel LAATSTE verrekening van die dag) ----
function undoVerrekeningForDate(ymdStr){
  const arr = Array.isArray(state.verrekeningen) ? state.verrekeningen : [];

  // pak alle verrekeningen van die datum
  const matches = arr
    .map((v, idx) => ({ v, idx }))
    .filter(x => x.v && x.v.date === ymdStr);

  if(matches.length === 0){
    showToast(t("verrek_none"), "warn");
    return;
  }

  // verwijder enkel de meest recente (hoogste createdAt)
  matches.sort((a,b) => (b.v.createdAt||0) - (a.v.createdAt||0));
  const removeIdx = matches[0].idx;

  arr.splice(removeIdx, 1);

  state.verrekeningen = arr;

  // totaal opnieuw uitrekenen (veiligste)
  state.overtimePaidMinutes = arr.reduce((sum, v) => sum + (v.minutes || 0), 0);

  saveState();
  showToast(t("verrek_deleted"), "ok");
  renderAll();
  openDayDetail(ymdStr);
}
// ===== TOEVOEGING VERREKENINGEN END =====

function openDayDetail(ymdStr){
  const e = entryForDate(ymdStr);

  const vMins = (Array.isArray(state.verrekeningen) ? state.verrekeningen : [])
    .filter(v => !v.deletedAt && v.date === ymdStr)
    .reduce((sum, v) => sum + (v.minutes || 0), 0);

  if(dayTitle){
    dayTitle.textContent = dmy(new Date(ymdStr));
    dayTitle.dataset.ymd = ymdStr;
  }

  if(dayBody) dayBody.innerHTML = "";

  // GEEN entry: toch tonen als er verrekend is
  if(!e){
    if(dayBody){
      dayBody.innerHTML = (vMins > 0)
        ? `
          <b>Verrekend</b><br>${formatHM(vMins)}
          <div style="margin-top:12px;">
            <button type="button" class="btnGhostSmall" id="btnUndoVerrek">Verrekening verwijderen</button>
          </div>
        `
        : "Geen entry op deze dag.";
    }
    if(dayEdit) dayEdit.style.display = "none";
    if(dayOverlay) dayOverlay.style.display = "flex";

    if(vMins > 0){
      document.getElementById("btnUndoVerrek")?.addEventListener("click", () => undoVerrekeningForDate(ymdStr));
    }
// ===== TOEVOEGING DAGDETAIL START =====
if(dayBody){
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "btnGhostSmall";
  btn.textContent = t("btn_add_manual");
  btn.style.marginTop = "12px";

  btn.addEventListener("click", () => {
    const mDate = document.getElementById("mDate");
    if(mDate) mDate.value = ymdStr;

    const modalBack = document.getElementById("modalBack");
    if(modalBack) modalBack.style.display = "flex";
  });

  dayBody.appendChild(btn);
}
// ===== TOEVOEGING DAGDETAIL END =====
    return;
  }

  if(dayEdit) dayEdit.style.display = "inline-block";

  const noteLine = e.note
    ? `<br><br><b>${t("note_label")}:</b><br>${escapeHtml(e.note)}`
    : "";

  // ===== WERK =====
  if(e.type === "Werk"){
    const start = e.start || "";
    const end   = e.end || "";
    const pause = (e.pauseMin || 0);
    const net   = formatHM(e.netMin || 0);

    if(dayBody) dayBody.innerHTML =
      `<b>${t("work_label")}</b><br>
       ${start}${end ? "‚Äì"+end : ""}<br>
       ${t("pause_line")}: ${pause} ${t("min")}<br>
       ${t("net_line")}: ${net}
       ${noteLine}`;
  }

  // ===== RECUP =====
  else if(e.type === "Recup"){
    const hm = formatHM(e.netMin || 0);
    if(dayBody) dayBody.innerHTML =
      `<b>${t("recup")}</b><br>
       ${t("recup_line")} (${hm})
       ${noteLine}`;
  }

  // ===== ANDERE TYPES =====
  else{
    const map = { "Ziekte":"sick", "Vakantie":"vacation", "Feestdag":"holiday" };
    const key = map[e.type];
    const label = key ? t(key) : e.type;

    if(dayBody) dayBody.innerHTML =
      `<b>${escapeHtml(label)}</b>
       ${noteLine}`;
  }

  // ===== VERREKEND TONEN + UNDO =====
  if(vMins > 0 && dayBody){
    dayBody.innerHTML += `
      <hr>
      <div class="verrekRow">
        <div><b>Verrekend</b><br>${formatHM(vMins)}</div>
        <button type="button" class="btnGhostSmall" id="btnUndoVerrek">Verrekening verwijderen</button>
      </div>
    `;
    document.getElementById("btnUndoVerrek")?.addEventListener("click", () => undoVerrekeningForDate(ymdStr));
  }

  if(dayOverlay) dayOverlay.style.display = "flex";
}


// =========================
// HELPERS
// =========================
function formatHMS(ms){
  const totalSec = Math.floor(ms/1000);
  const h = Math.floor(totalSec/3600);
  const m = Math.floor((totalSec%3600)/60);
  const s = totalSec%60;
  return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
}

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function parseVerrekenToMinutes(str){
  const s = (str || "").trim();
  if(!s.includes(":")) return 0;

  const [hRaw, mRaw] = s.split(":");
  const h = parseInt(hRaw || "0", 10);
  const m = parseInt(mRaw || "0", 10);

  if(Number.isNaN(h) || Number.isNaN(m)) return 0;
  if(m < 0 || m > 59) return 0;

  return h * 60 + m;
}

function parseHM(str){
  const s = String(str).trim();
  const hm = s.match(/^(\d+)\s*:\s*([0-5]\d)$/);
  if(hm) return parseInt(hm[1],10)*60 + parseInt(hm[2],10);
  if(/^\d+$/.test(s)) return parseInt(s,10);
  return null;
}

function timeToMin(t){
  if(!t) return null;
  const [hh,mm] = t.split(":").map(x=>parseInt(x,10));
  if(Number.isNaN(hh)||Number.isNaN(mm)) return null;
  return hh*60+mm;
}

function minToTime(min){
  const h = Math.floor(min/60);
  const m = min%60;
  return `${pad2(h)}:${pad2(m)}`;
}

function clamp(n,a,b){
  return Math.max(a, Math.min(b,n));
}

function uid(){
  return Math.random().toString(36).slice(2,10)
    + "-" + Date.now().toString(36);
}

function setSaldoColor(el, min){
  if(!el) return;
  el.classList.remove("salpos","salneg","salzero");
  if(min > 0) el.classList.add("salpos");
  else if(min < 0) el.classList.add("salneg");
  else el.classList.add("salzero");
}

function verrekeningenForDate(ymd){
  const arr = Array.isArray(state.verrekeningen)
    ? state.verrekeningen
    : [];
  return arr.filter(v => v.date === ymd);
}

function hmFromMinutes(mins){
  const h = Math.floor(mins/60);
  const m = Math.abs(mins % 60);
  return `${h}:${String(m).padStart(2,"0")}`;
}
  /* =========================
     Timer + Status
     ========================= */
  let interval = null;

  function currentElapsedMs(){
    if(state.timer.running && state.timer.startMs!=null){
      return state.timer.accMs + (Date.now() - state.timer.startMs);
    }
    return state.timer.accMs || 0;
  }

  function updateTimerUI(){
    if(elTimer) elTimer.textContent = formatHMS(currentElapsedMs());
  }

  function setStatus(mode){
    if(!elStatus) return;

    const label =
      mode === "playing" ? t("status_busy") :
      mode === "paused"  ? t("status_paused") :
                           t("status_not_started");

    const cls =
      mode === "playing" ? "play" :
      mode === "paused"  ? "pause" :
                           "stop";

    elStatus.innerHTML = `<span class="iconBox ${cls}"></span><span>${label}</span>`;
  }

  function startTimer(){
    if(state.timer.running) return;
    state.timer.running = true;
    state.timer.startMs = Date.now();
    if(!interval) interval = setInterval(()=>{ updateTimerUI(); saveState(); }, 250);
    setStatus("playing");
    saveState();
  }

  function pauseTimer(){
    if(!state.timer.running) return;
    const now = Date.now();
    state.timer.accMs += (now - state.timer.startMs);
    state.timer.running = false;
    state.timer.startMs = null;
    setStatus("paused");
    updateTimerUI();
    saveState();
  }

  function resetTimer(){
    state.timer.running = false;
    state.timer.startMs = null;
    state.timer.accMs = 0;
    updateTimerUI();
    setStatus("stopped");
    saveState();
  }

  /* =========================
     Totals
     ========================= */
  function weekStart(d = new Date()){
    const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = (dd.getDay()+6)%7;
    dd.setDate(dd.getDate()-day);
    dd.setHours(0,0,0,0);
    return dd;
  }

  function inSameWeek(dateYMD){
    const ws = weekStart(new Date());
    const we = new Date(ws); we.setDate(ws.getDate()+7);
    const d = new Date(dateYMD+"T00:00:00");
    return d>=ws && d<we;
  }

  function workNetForDate(dateYMD){
    return state.entries
      .filter(e=>!e.deletedAt && e.date===dateYMD && e.type==="Werk")
      .reduce((a,e)=>a + (e.netMin||0), 0);
  }
  function vacationDaysTaken(){
  const year = new Date().getFullYear();
  const prefix = year + "-"; // omdat datum = "YYYY-MM-DD"

  const set = new Set();

  state.entries.forEach(e=>{
    if(
      !e.deletedAt &&
      e.type === "Vakantie" &&
      typeof e.date === "string" &&
      e.date.startsWith(prefix)
    ){
      set.add(e.date); // telt per unieke dag
    }
  });

  return set.size;
}

  function overtimeSaldoMin(){
    const start = state.settings.startSaldoMin || 0;
    const normDay = state.settings.normDayMin ?? NORM_MIN;
    const days = [...new Set(state.entries.filter(e=>!e.deletedAt).map(e=>e.date))].sort();

  let sum = start - (state.overtimePaidMinutes || 0);
    for(const day of days){
      const hasWork = state.entries.some(e=>!e.deletedAt && e.date===day && e.type==="Werk");
      const workNet = workNetForDate(day);
      if(hasWork) sum += (workNet - normDay);

      const recups = state.entries.filter(e=>!e.deletedAt && e.date===day && e.type==="Recup").length;
      if(recups>0) sum += (-normDay * recups);
    }
    return sum;
  }

  /* =========================
     Actions
     ========================= */
  function saveWorkEntry(){
    const ms = currentElapsedMs();
    if(ms < 1000){
      showToast(t("err_timer_short"), "warn");
      return;
    }

    const pause = clamp(parseInt(elPauseMin?.value||"0",10)||0, 0, 600);
    const now = new Date();
    const date = ymd(now);

    const durMin = Math.max(0, Math.round(ms/60000));
    const netMin = Math.max(0, durMin - pause);

    const endMin = now.getHours()*60 + now.getMinutes();
    const startDate = new Date(now.getTime() - ms);
    const startMin = startDate.getHours()*60 + startDate.getMinutes();

    state.entries.unshift({
      id: uid(), date, type:"Werk",
      start: minToTime(startMin), end: minToTime(endMin),
      pauseMin: pause, netMin, createdAt: Date.now()
    });

    saveState();
    resetTimer();
    showToast(`${t("save")} ‚úì`, "ok");
    renderAll();
  }

  function msgRecupConfirm(){
    if(currentLang === "fr") return `Ajouter un jour de r√©cup pour ${dmy(new Date())} ?\nCela enl√®ve 7h30 de tes heures sup.`;
    if(currentLang === "en") return `Add comp day for ${dmy(new Date())}?\nThis subtracts 7h30 from your overtime.`;
    return `RECUP toevoegen voor ${dmy(new Date())}?\nDit doet 7u30 op je overuren.`;
  }

  function addRecup(){
    openConfirm(msgRecupConfirm(), () => {
      state.entries.unshift({
        id: uid(), date: ymd(new Date()), type:"Recup",
        start:null, end:null, pauseMin:0, netMin: RECUP_MIN, createdAt: Date.now()
      });
      saveState();
      showToast(`${t("recup")} ‚úì`, "ok");
      renderAll();
    });
  }

  /* =========================
     Modal (manual add/edit)
     ========================= */
  let editingId = null;

  function openModal(mode, entry=null){
    editingId = entry ? entry.id : null;

    if(modalTitle){
      modalTitle.textContent = mode==="edit" ? t("modal_edit_title") : t("modal_add_title");
    }

    if(btnDeleteInModal){
      btnDeleteInModal.style.display = mode==="edit" ? "inline-block" : "none";
    }

    if(mDate) mDate.value = entry?.date || ymd(new Date());
    if(mType) mType.value = entry?.type || "Werk";

    const effType = entry?.type || (mType ? mType.value : "Werk");

    if(effType==="Recup"){
      if(mStart) mStart.value = "";
      if(mEnd)   mEnd.value   = "";
      if(mPause) mPause.value = 0;
    }else{
      if(mStart) mStart.value = entry?.start || "06:00";
      if(mEnd)   mEnd.value   = entry?.end   || "14:00";
      if(mPause) mPause.value = entry?.pauseMin ?? 30;
    }

    if(mNote) mNote.value = entry?.note || "";

    if(modalBack) modalBack.style.display = "flex";
    applyLang();
  }

  function closeModal(){
    if(modalBack) modalBack.style.display = "none";
    editingId = null;
  }

  function netFromFields(type, start, end, pauseMin){
  // Deze types tellen niet mee als werkuren (0 min)
  if(type === "Ziekte" || type === "Vakantie" || type === "Feestdag"){
    return 0;
  }
  
    if(type==="Recup") return RECUP_MIN;

    const s = timeToMin(start);
    const e = timeToMin(end);
    if(s==null || e==null) return null;

    let dur = e - s;
    if(dur < 0) dur += 24*60;

    return Math.max(0, dur - pauseMin);
  }

  function saveModal(){
  const date = mDate?.value;
  const type = mType?.value || "Werk";

  // lees velden (mag leeg zijn bij sommige types)
  let start = (mStart?.value || "").trim();
  let end   = (mEnd?.value || "").trim();
  let pauseMin = clamp(parseInt(mPause?.value || "0", 10) || 0, 0, 600);

  if(!date){
    showToast(t("err_choose_date"));
    return;
  }

  const isZeroType = (type === "Ziekte" || type === "Vakantie" || type === "Feestdag");

  // ‚úÖ Zero-types: geen tijden nodig, alles naar null/0
  if(isZeroType){
    start = null;
    end = null;
    pauseMin = 0;
  }

  const netMin = isZeroType ? 0 : netFromFields(type, start, end, pauseMin);

  if(netMin == null){
    showToast(t("err_fill_times"));
    return;
  }

  if(editingId){
    const idx = state.entries.findIndex(e=>e.id===editingId);
    if(idx === -1) return;

    state.entries[idx] = {
      ...state.entries[idx],
      date,
      type,
      start: (type==="Recup" || isZeroType) ? null : start,
      end:   (type==="Recup" || isZeroType) ? null : end,
      pauseMin: (type==="Recup" || isZeroType) ? 0 : pauseMin,
      netMin,
      note: (mNote?.value || "").trim()
    };
  }else{
    state.entries.unshift({
      id: uid(),
      date,
      type,
      start: (type==="Recup" || isZeroType) ? null : start,
      end:   (type==="Recup" || isZeroType) ? null : end,
      pauseMin: (type==="Recup" || isZeroType) ? 0 : pauseMin,
      netMin,
      note: (mNote?.value || "").trim(),
      createdAt: Date.now()
    });
  }

  saveState();
  closeModal();
  showToast("OK ‚úì", "ok");
  renderAll();
}

  mType?.addEventListener("change", ()=>{
  const v = mType.value;

  const isZeroType = (v==="Ziekte" || v==="Vakantie" || v==="Feestdag");

  if(v==="Recup" || isZeroType){
    if(mStart) mStart.value = "";
    if(mEnd)   mEnd.value   = "";
    if(mPause) mPause.value = 0;
  }else{
    if(mStart && !mStart.value) mStart.value = "08:00";
    if(mEnd   && !mEnd.value)   mEnd.value   = "15:30";
    if(mPause && !mPause.value) mPause.value = 30;
  }
});
  function deleteEditing(){
    if(!editingId) return;
    openConfirm(t("confirm_delete_entry"), () => {
      const idx = state.entries.findIndex(e=>e.id===editingId);
      if(idx>=0) state.entries[idx].deletedAt = Date.now();
      saveState();
      closeModal();
      renderAll();
    });
  }

  /* =========================
     History rendering
     ========================= */
  function entryTitle(e){
    const d = new Date(e.date);
    const loc = currentLang==="fr" ? "fr-FR" : currentLang==="en" ? "en-GB" : "nl-BE";
    return d.toLocaleDateString(loc);
  }

  function entrySubtitle(e){
  const noteLine = e.note ? `<br><br><span class="noteLine">üìù ${e.note}</span>` : "";

  if(e.type==="Recup"){
    return `${t("recup").toUpperCase()}<br>${t("recup_line")} (${formatHM(e.netMin||0)})${noteLine}`;
  }

if(e.type==="Ziekte" || e.type==="Vakantie" || e.type==="Feestdag"){
  const map = { "Ziekte":"sick", "Vakantie":"vacation", "Feestdag":"holiday" };
  const key = map[e.type];
  return `${(key ? t(key) : e.type).toUpperCase()}${noteLine}`;
}
  return `${t("work_label")}<br>
${e.start || "-"}-${e.end || "-"}<br>
${t("net_line")} ${formatHM(e.netMin||0)}<br>
${t("pause_line")} ${e.pauseMin||0} ${t("minutes")}${noteLine}`;
}

  function entryChip(e){ return formatHM(e.netMin || 0); }

  function renderHistory(){
    if(!elHistoryList) return;
    const list = state.entries
      .filter(e=>!e.deletedAt)
      .slice()
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    if(list.length===0){
      elHistoryList.innerHTML = `<div class="muted" style="font-weight:950; margin-top:12px;">Nog geen entries.</div>`;
      return;
    }

    elHistoryList.innerHTML = "";
    list.forEach(e=>{
      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <div class="left">
          <div class="t1">${entryTitle(e)}</div>
          <div class="t2">${entrySubtitle(e)}</div>
        </div>
        <div class="right">
          <div class="chip">${entryChip(e)}</div>
<button class="btnSmall"
        data-act="edit"
        data-i18n-aria="btn_edit"
        aria-label="">
  ‚úé
</button>
          <button class="btnSmall btnDanger" data-act="del">X</button>
        </div>
      `;
      div.querySelector('[data-act="edit"]')?.addEventListener("click", ()=> openModal("edit", e));
      div.querySelector('[data-act="del"]')?.addEventListener("click", ()=>{
        openConfirm(t("confirm_delete_entry"), () => {
          const idx = state.entries.findIndex(x=>x.id===e.id);
          if(idx>=0) state.entries[idx].deletedAt = Date.now();
          saveState();
          renderAll();
        });
      });
      elHistoryList.appendChild(div);
    });
  }

  /* =========================
     Backup meta
     ========================= */
  function renderBackupMeta(){
    if(!elLastBackupText) return;

    if(meta.lastBackupAt){
      const d = new Date(meta.lastBackupAt);
      const txt = `${dmy(d)} ${pad2(d.getHours())}:${pad2(d.getMinutes())} (${meta.lastBackupName||t("backup")})`;
      elLastBackupText.textContent = `${t("backup_last")}: ${txt}`;
    }else{
      elLastBackupText.textContent = `${t("backup_last")}: ${t("backup_never")}`;
    }
  }

  function setLastBackup(at, name){
    meta.lastBackupAt = at;
    meta.lastBackupName = name;
    saveMeta();
  }

  function exportJSON(withDownloadName=null){
    const data = JSON.stringify({state, meta}, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);

    const name = withDownloadName || `shift-tap-backup-${ymd(new Date())}.json`;
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    setLastBackup(Date.now(), name);
    renderBackupMeta();
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        if(parsed && parsed.state && parsed.meta){
          state = parsed.state;
          meta  = parsed.meta;
        }else if(parsed && parsed.settings && parsed.entries){
          state = parsed;
          meta  = { lastBackupAt:null, lastBackupName:null };
        }else{
          showToast(t("err_bad_json"), "err");
          return;
        }

        if(!state.settings) state.settings = { startSaldoMin:0, normDayMin:NORM_MIN, lang:"nl" };
        if(!state.timer)    state.timer    = { running:false, startMs:null, accMs:0 };
        if(!Array.isArray(state.entries)) state.entries = [];
        if(!meta) meta = { lastBackupAt:null, lastBackupName:null };

        saveState(); saveMeta();
        renderAll();
        showToast("Import ‚úì", "ok");
      }catch(e){
        showToast(t("err_bad_json"), "err");
      }
    };
    reader.readAsText(file);
  }

  

/* =========================
   Google login + Cloud sync (Firebase)
   ========================= */

/**
 * Belangrijk:
 * - Deze app draait als PWA (GitHub Pages / HTTPS).
 * - Voor Google login moet je in Firebase Console bij Authentication ‚Üí Settings
 *   je domein toevoegen aan "Authorized domains" (bv. <user>.github.io).
 * - Als dat niet klopt, zie je hieronder een duidelijke foutmelding.
 */

const elCloudStatus = document.getElementById("cloudStatus");

function setCloudStatus(txt){
  if(elCloudStatus) elCloudStatus.textContent = txt || "‚Äî";
}

function currentUser(){
  try{
    return fbAuth?.currentUser || null;
  }catch(e){
    return null;
  }
}

function backupObject(){
  return {
    state,
    meta,
    cloud: {
      appId: APP_ID,
      channel: APP_CHANNEL,
      version: APP_VERSION,
      exportedAt: Date.now()
    }
  };
}

function cloudDocRef(uid){
  // 1 doc per user per app/channel
  const docId = `${APP_ID}_${APP_CHANNEL}`;
  return fbDb.collection("users").doc(uid).collection("apps").doc(docId);
}

/* ---------- Redirect result (mobiel/PWA) ---------- */
async function handleRedirectLoginResult(){
  if(!(await ensureFirebase())){
    setCloudStatus("Cloud: niet geconfigureerd.");
    setCloudUiEnabled(false);
    return;
  }

  const elLoginNote = document.getElementById("loginNote");

  try {
    const res = await fbAuth.getRedirectResult();

    if (res && res.user) {
      showToast(`‚úÖ ${t("cloud_logged_in")} ${res.user.email || "Google"}`, "ok");
    }
  } catch (e) {
    console.error("getRedirectResult:", e);

    const code = e?.code ? String(e.code) : "login-error";
    showToast(`‚ùå ${t("cloud_login_error")} (${code})`, "warn");
    setCloudStatus(`‚ùå ${t("cloud_login_error")}: ${code}`);

    if (elLoginNote) {
      elLoginNote.textContent = `‚ùå ${t("cloud_login_error")}: ${code}`;
    }
  }
}

/* ---------- Login / Logout ---------- */
async function loginGoogle(){
  if(!(await ensureFirebase())){
    showToast("Cloud niet geconfigureerd.", "warn");
    return;
  }
  try{
  const provider = new firebase.auth.GoogleAuthProvider();
  await fbAuth.signInWithPopup(provider);
}catch(e){
  // Als popup geblokkeerd is, proberen we toch redirect (alleen dan)
  if (e && (e.code === "auth/popup-blocked" || e.code === "auth/popup-closed-by-user")) {
    const provider = new firebase.auth.GoogleAuthProvider();
    await fbAuth.signInWithRedirect(provider);
    return;
  }
  console.error("loginGoogle:", e);
  showToast("‚ùå Inloggen mislukt", "warn");
}
}

async function logoutGoogle(){
  if(!(await ensureFirebase())) return;
  try{
    await fbAuth.signOut();
    showToast("Uitgelogd.", "ok");
  }catch(e){
    console.error("logoutGoogle:", e);
    showToast("‚ùå Uitloggen mislukt", "warn");
  }
}

/* ---------- Cloud push / pull ---------- */
async function cloudPush(){
  if(!(await ensureFirebase())){
    showToast("Cloud niet geconfigureerd.", "warn");
    return;
  }
  const u = currentUser();
  if(!u){
    showToast("Log eerst in met Google.", "warn");
    return;
  }

  try{
    showToast("‚¨ÜÔ∏è Upload bezig...", "ok");
    const payload = backupObject();
    await cloudDocRef(u.uid).set({
      payload,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    setCloudStatus(`‚úÖ Cloud bijgewerkt (${u.email || "Google"})`);
    showToast("‚úÖ Backup naar cloud gelukt", "ok");
  }catch(err){
    console.error(err);
    showToast("‚ùå Cloud upload mislukt", "warn");
  }
}

async function cloudPull(){
  if(!(await ensureFirebase())){
    showToast("Cloud niet geconfigureerd.", "warn");
    return;
  }
  const u = currentUser();
  if(!u){
    showToast("Log eerst in met Google.", "warn");
    return;
  }

  try{
    showToast("‚¨áÔ∏è Download bezig...", "ok");
    const snap = await cloudDocRef(u.uid).get();
    if(!snap.exists){
      showToast("Geen cloud-backup gevonden.", "warn");
      return;
    }

    const payload = snap.data()?.payload || null;
    if(!payload?.state){
      showToast("Cloud-backup is ongeldig.", "warn");
      return;
    }

    openConfirm("Cloud ‚Üí toestel: dit overschrijft je data op dit toestel. Doen?", ()=>{
      state = payload.state;
      meta  = payload.meta || meta;

      // safety defaults
      if(!state.settings) state.settings = { startSaldoMin:0, normDayMin:NORM_MIN, lang:"nl" };
      if(!state.timer)    state.timer    = { running:false, startMs:null, accMs:0 };
      if(!Array.isArray(state.entries)) state.entries = [];
      if(!Array.isArray(state.verrekeningen)) state.verrekeningen = [];
      if(typeof state.overtimePaidMinutes !== "number") state.overtimePaidMinutes = 0;
      if(!meta) meta = { lastBackupAt:null, lastBackupName:null };

      saveState();
      saveMeta();
      renderAll();

      setCloudStatus(`‚¨áÔ∏è Cloud geladen (${u.email || "Google"})`);
      showToast("‚úÖ Cloud ‚Üí toestel gelukt", "ok");
    });
  }catch(err){
    console.error(err);
    showToast("‚ùå Cloud download mislukt", "warn");
  }
}

/* ---------- UI wiring ---------- */
function bindCloudButtons(){
  btnGoogleLogin?.addEventListener("click", ()=> loginGoogle().catch(console.error));
  btnGoogleLogout?.addEventListener("click", ()=> logoutGoogle().catch(console.error));
  btnCloudPush?.addEventListener("click", ()=> cloudPush().catch(console.error));
  btnCloudPull?.addEventListener("click", ()=> cloudPull().catch(console.error));
}

async function wireCloudAuthUI(){
  // knoppen standaard uit tot we Firebase zeker hebben
  setCloudUiEnabled(false);

  if(!(await ensureFirebase())){
    setCloudStatus("Cloud: niet geconfigureerd.");
    if(elLoginNote) elLoginNote.textContent = "Nog niet mogelijk (Firebase niet geconfigureerd).";
    return;
  }

  // Vanaf hier: Firebase OK
  setCloudUiEnabled(true);
  setCloudStatus("Niet ingelogd.");

  // 1x listener (blijft actief)
  fbAuth.onAuthStateChanged((u)=>{
    setLoginUi(u);

    if(u){
      setCloudStatus(`‚úÖ Ingelogd: ${u.email || u.displayName || "Google"}`);
      // login knop verbergen gebeurt al in setLoginUi
      if(btnCloudPull) btnCloudPull.disabled = false;
      if(btnCloudPush) btnCloudPush.disabled = false;
    }else{
      setCloudStatus("Niet ingelogd.");
      if(btnCloudPull) btnCloudPull.disabled = true;
      if(btnCloudPush) btnCloudPush.disabled = true;
    }
  });
}


/* =========================
     Settings
     ========================= */
  function renderSettings(){
    if(elStartSaldoInput) elStartSaldoInput.value = formatHM(state.settings.startSaldoMin || 0);
    if(elNormDayInput)    elNormDayInput.value    = formatHM(state.settings.normDayMin ?? NORM_MIN);
  }

  function saveSettings(){
    const mins = parseHM(elStartSaldoInput?.value);
    if(mins==null){ showToast(t("err_start_saldo_format"), "warn"); return; }
    const norm = parseHM(elNormDayInput?.value);
    if(norm==null){ showToast(t("err_normday_format"), "warn"); return; }

    state.settings.startSaldoMin = mins;
    state.settings.normDayMin = norm;
    state.settings.lang = currentLang;

    saveState();
    renderAll();
    showToast(t("settings_saved"), "ok");
  }

  function renderOnlineBadge(){
    if(!elOnlineBadge) return;
    const online = navigator.onLine;
    elOnlineBadge.textContent = online ? t("status_online") : t("status_offline");
    elOnlineBadge.classList.toggle("ok", online);
    elOnlineBadge.classList.toggle("warn", !online);
  }

  function formatTodayPill(){
    const loc = currentLang==="fr" ? "fr-FR" : currentLang==="en" ? "en-GB" : "nl-BE";
    return new Date().toLocaleDateString(loc, { weekday:"short", day:"2-digit", month:"2-digit", year:"numeric" });
  }

  function renderTotals(){
    const today = ymd(new Date());
    const todayNet = workNetForDate(today);

    const weekNet = state.entries
      .filter(e=>!e.deletedAt && e.type==="Werk" && inSameWeek(e.date))
      .reduce((a,e)=>a+(e.netMin||0),0);

    const ot = overtimeSaldoMin();
    const vacDays = vacationDaysTaken();
    if(elVacTaken) elVacTaken.textContent = String(vacDays);

    if(elTodayWork) elTodayWork.textContent = formatHM(todayNet);
    if(elWeekWork)  elWeekWork.textContent  = formatHM(weekNet);

    if(elOvertimeSaldo){
      const normDay = state.settings.normDayMin ?? NORM_MIN;
      const totalDays = normDay > 0 ? (ot / normDay) : 0;

      const cls = ot > 0 ? "otPos" : (ot < 0 ? "otNeg" : "otZero");

elOvertimeSaldo.innerHTML = `
  <div class="saldoMain ${cls}">
    ${formatHM(ot)} <span class="unit">${t("hours")}</span>
  </div>
  <div class="saldoSub">
    = ${ot} <span>${t("minutes")}</span><br>
    = ${totalDays.toFixed(2)} <span>${t("days")}</span>
  </div>
`;

      setSaldoColor(elOvertimeSaldo, ot);
      const card = elOvertimeSaldo.closest(".miniCard");
      if(card) setSaldoColor(card, ot);
    }
  }

  function renderAll(){
    if(elTodayPill) elTodayPill.textContent = formatTodayPill();
    updateTimerUI();
    renderTotals();
    renderHistory();
    renderBackupMeta();
    renderSettings();
    renderOnlineBadge();
    applyLang();
    // als kalender zichtbaar is ‚Üí opnieuw tekenen
  const tab3 = document.getElementById("tab3");
  if(tab3 && tab3.style.display !== "none"){
    renderCalendar();
  }
  }

  /* =========================
   Bind events
   ========================= */

// Basis knoppen
btnStart?.addEventListener("click", startTimer);
btnPause?.addEventListener("click", pauseTimer);
btnSave?.addEventListener("click", saveWorkEntry);
btnRecup?.addEventListener("click", addRecup);
btnAddManual?.addEventListener("click", ()=> openModal("add"));

// Backup
btnBackupNow?.addEventListener("click", ()=> exportJSON());
fileImport2?.addEventListener("change", (e)=>{
  const f = e.target.files?.[0];
  if(f) importJSON(f);
  e.target.value = "";
});

// Verrekenen
const verrekenAmount = document.getElementById("verrekenAmount");
const verrekenDate   = document.getElementById("verrekenDate");
const btnSaveVerreken = document.getElementById("btnSaveVerrekening");
const btnCloseVerreken = document.getElementById("btnCloseVerreken");

document.getElementById("btnVerreken")?.addEventListener("click", () => {
  if(verrekenDate) verrekenDate.value = todayISO();
  if(verrekenAmount && !verrekenAmount.value) verrekenAmount.value = "0:00";
  if(verrekenModal) verrekenModal.style.display = "flex";
});

btnCloseVerreken?.addEventListener("click", () => {
  if(verrekenModal) verrekenModal.style.display = "none";
});

verrekenModal?.addEventListener("click", (e) => {
  if(e.target === verrekenModal) verrekenModal.style.display = "none";
});

btnSaveVerreken?.addEventListener("click", () => {
  const date = (verrekenDate?.value || "").trim();
  const amountStr = (verrekenAmount?.value || "").trim();

  if(!date){
    showToast("Kies een datum.", "warn");
    return;
  }

  const mins = parseHM(amountStr);
  if(mins == null){
    showToast("Vul uren in als u:min (bv 10:00).", "warn");
    return;
  }

  state.verrekeningen = state.verrekeningen || [];
  state.verrekeningen.unshift({
    id: uid(),
    date,
    minutes: mins,
    createdAt: Date.now()
  });

  state.overtimePaidMinutes = (state.overtimePaidMinutes || 0) + mins;

  saveState();
  if(verrekenModal) verrekenModal.style.display = "none";
  showToast("Verrekenen ‚úì", "ok");
  renderAll();
});

// Dag detail
dayClose?.addEventListener("click", closeDayDetail);

dayOverlay?.addEventListener("click", (ev)=>{
  if(ev.target === dayOverlay) closeDayDetail();
});

dayEdit?.addEventListener("click", () => {
  const ymdStr = dayTitle?.dataset?.ymd;
  if(!ymdStr) return;

  const e = entryForDate(ymdStr);
  if(!e) return;

  closeDayDetail();
  openModal("edit", e);
});

// Settings
btnSaveSettings?.addEventListener("click", saveSettings);
btnCloseModal?.addEventListener("click", closeModal);
modalBack?.addEventListener("click", (e)=>{ if(e.target===modalBack) closeModal(); });
btnSaveModal?.addEventListener("click", saveModal);
btnDeleteInModal?.addEventListener("click", deleteEditing);

if(langSelect){
  langSelect.addEventListener("change", ()=>{
    currentLang = langSelect.value;
    state.settings.lang = currentLang;
    saveState();
    renderAll();
  });
}

window.addEventListener("online", renderOnlineBadge);
window.addEventListener("offline", renderOnlineBadge);


/* =========================
   INIT
   ========================= */

async function init(){
  try{
    await handleRedirectLoginResult();
  }catch(e){
    console.warn("redirect init error:", e);
  }

  try{
    await wireCloudAuthUI();
  }catch(e){
    console.warn("auth UI error:", e);
  }

  bindCloudButtons();

  showTab("tab1");

  if(state.timer.running){
    if(!interval) interval = setInterval(()=>{ 
      updateTimerUI(); 
      saveState(); 
    }, 250);
    setStatus("playing");
  }else{
    setStatus(state.timer.accMs>0 ? "paused" : "stopped");
  }

  renderAll();
}

init();
})();

</script>
<!-- ===== TOEVOEGING CONFIRM MODAL START ===== -->
<div class="appModalOverlay" id="appModalOverlay" aria-hidden="true">
  <div class="appModal" role="dialog" aria-modal="true" aria-labelledby="appModalBody">
    <div class="appModalBody" id="appModalBody"></div>

    <div class="appModalActions">
      <button type="button" class="btnGhost" id="appModalCancel" data-i18n="cancel">Annuleren</button>
      <button type="button" class="btnGreen" id="appModalOk" data-i18n="ok">OK</button>
    </div>
  </div>
</div>
<!-- ===== TOEVOEGING CONFIRM MODAL END ===== -->


</body>
</html>